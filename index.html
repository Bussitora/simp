<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FullPage.js — Кастомный горизонтальный скролл</title>

    <!-- fullPage.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullpage.js@4.0.23/dist/fullpage.min.css" />

    <style>
        .fp-slides{
            width:100%;
        }

        .fp-slidesContainer{
            width:100% !important;
        }

        .slide-preview {
            position: absolute;
            right: 0;
            top: 0;
            height: 100vh;
            width: 240px;
            background: rgba(255, 255, 255, 0.95);
            padding: 0 15px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            pointer-events: none;
        }

        .preview-carousel {
            width: 100%;
            overflow-y: auto;
            scrollbar-width: none;
            display: flex;
            flex-direction: column;
            gap: 60px; /* ✅ Между элементами — 60px */
            padding: 0; /* Убрали padding — используем спейсеры */
        }

        .preview-carousel::-webkit-scrollbar {
            display: none;
        }

        .preview-item {
            display: flex;
            align-items: center;
            width: 100%;
            max-width: 200px;
            min-height: 240px; 
            padding: 0 16px;
            cursor: pointer;
            background: #f8f9fa;
            transition: all 0.3s ease;
            opacity: 0.5;
            pointer-events: auto;
            flex-shrink: 0;
            box-sizing: border-box;
            border: 2px solid black;
            margin: 0;
        }

        .preview-item.active {
            opacity: 1;
            background: #d0e7ff;
        }

        .preview-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 14px;
            flex-shrink: 0;
        }

        .preview-item > div {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Спейсеры для центрирования крайних элементов */
        .preview-spacer {
            width: 100%;
            height: 100vh; /* ✅ "Воздух" сверху и снизу */
            flex-shrink: 0;
            pointer-events: none;
        }


        .section {
            text-align: center;
            font-size: 2.5em;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .slide {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8em;
            color: white;
        }

        /* Цвета секций */
        #section1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        #section2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        #section3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        #section4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        #section5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #section2 .slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100%;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.6s ease-in-out;
            align-items: center;
            justify-content: center;
        }

        #section2 .slide.active {
            opacity: 1;
            pointer-events: auto;
        }

        @media (max-width: 1439px) {
            
            .fp-slidesContainer{
                width:100% !important;
                transform: translate3d(0px, 0px, 0px) !important;
            }

            /* Слайды внутри секции 2 становятся вертикальными блоками */
            #section2 .slide {
                height: auto !important;
                width: 100% !important;
                padding: 40px 20px;
                box-sizing: border-box;
                flex-direction: column;
                min-height: 30vh;
                background: inherit;
                scroll-snap-align: start;
                position: relative;
                opacity: 1 !important;
                pointer-events: auto !important;
                transition: none;
            }

            /* Превью скрывается */
            .slide-preview {
                display: none !important;
            }

            /* Разрешаем естественную прокрутку */
            #fullpage {
                height: auto !important;
                overflow: visible;
            }

            .section {
                height: auto !important;
            }
        }
		
    </style>
</head>
<body>

<div id="fullpage">
    <div class="section" id="section1">
        <h2>Главный слайд 1</h2>
    </div>

    <div class="section" id="section2">
        <div class="slide">Вложенный слайд 1</div>
        <div class="slide">Вложенный слайд 2</div>
        <div class="slide">Вложенный слайд 3</div>
        <div class="slide">Вложенный слайд 4</div>
        <div class="slide">Вложенный слайд 5</div>

        <!-- Превью справа — вертикальная карусель -->
        <div class="slide-preview">
            <div class="preview-carousel">
                <div class="preview-spacer"></div> <!-- ✅ Пустой элемент снизу -->
                <div class="preview-item active" data-index="0">
                    <img src="https://picsum.photos/50/50?random=1" alt="Slide 1">
                    <div>Тема 1</div>
                </div>
                <div class="preview-item" data-index="1">
                    <img src="https://picsum.photos/50/50?random=2" alt="Slide 2">
                    <div>Тема 2</div>
                </div>
                <div class="preview-item" data-index="2">
                    <img src="https://picsum.photos/50/50?random=3" alt="Slide 3">
                    <div>Тема 3</div>
                </div>
                <div class="preview-item" data-index="3">
                    <img src="https://picsum.photos/50/50?random=4" alt="Slide 4">
                    <div>Тема 4</div>
                </div>
                <div class="preview-item" data-index="4">
                    <img src="https://picsum.photos/50/50?random=5" alt="Slide 5">
                    <div>Тема 5</div>
                </div>
                <div class="preview-spacer"></div> <!-- ✅ Пустой элемент снизу -->
            </div>
        </div>
    </div>

    <div class="section" id="section3">
        <h2>Главный слайд 3</h2>
    </div>

    <div class="section" id="section4">
        <h2>Главный слайд 4</h2>
    </div>

    <div class="section" id="section5">
        <h2>Главный слайд 5</h2>
    </div>
</div>

<!-- fullPage.js JS (open-source версия) -->
<!--
<script src="https://cdn.jsdelivr.net/npm/fullpage.js@4.0.23/dist/fullpage.min.js"></script>
-->
<script type="text/javascript" src="js/fullpage.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const mediaQuery = window.matchMedia('(max-width: 1439px)');
        const fullpageInstance = new fullpage('#fullpage', {
            licenseKey: 'OPEN_SOURCE_GPLV3_LICENSE',
            navigation: false,
            controlArrows: false,
            scrollingSpeed: 700,
			responsiveWidth: 1440,

            afterLoad: function (origin, destination, direction) {
                const preview = document.querySelector('.slide-preview');
                const sectionIndex = getSectionIndex(destination);

                if (sectionIndex === 1) {
                    activatePreviewForSlide(lastActiveSlideIndexInSection2);
                    if (!mediaQuery.matches) { // ✅ Только если не в адаптиве
                        attachWheelHandler();
                    }
                } else {
                    removeWheelHandler();
                }
            },

            afterSlideLoad: function (section, origin, destination, direction) {
                const sectionIndex = getSectionIndex(section);
                if (sectionIndex === 1) {
                    // ✅ Запоминаем активный слайд в секции 2
                    lastActiveSlideIndexInSection2 = destination.index;
                    activatePreviewForSlide(destination.index);
                }
            }
        });

        // ✅ Переменная для хранения последнего активного слайда в секции 2
        let lastActiveSlideIndexInSection2 = 0;

        function getSectionIndex(sectionObj) {
            if (typeof sectionObj.index === 'function') {
                return sectionObj.index();
            }
            if (typeof sectionObj.index === 'number') {
                return sectionObj.index;
            }
            const sections = document.querySelectorAll('.section');
            return Array.from(sections).indexOf(sectionObj.item);
        }

        let isScrolling = false;
        const throttleDelay = 800;

        function attachWheelHandler() {
            if (mediaQuery.matches) return; // ✅ Не добавляем в адаптиве
            const section2 = document.querySelector('#section2');
            if (section2) {
                section2.addEventListener('wheel', handleWheelScroll, { passive: false });
            }
        }

        function removeWheelHandler() {
            const section2 = document.querySelector('#section2');
            if (section2) {
                section2.removeEventListener('wheel', handleWheelScroll);
            }
        }

        function handleWheelScroll(event) {
            if (mediaQuery.matches) {
                return;
            }

            if (isScrolling) {
                event.preventDefault();
                event.stopPropagation();
                return;
            }

            const activeSlide = fullpageInstance.getActiveSlide();
            if (!activeSlide || typeof activeSlide.index !== 'number') {
                return;
            }

            const delta = event.deltaY > 0 ? 1 : -1;
            const currentSlideIndex = activeSlide.index;

            // ✅ Динамически определяем количество слайдов
            const totalSlides = document.querySelectorAll('#section2 .slide').length;
            let newIndex = currentSlideIndex + delta;

            newIndex = Math.max(0, Math.min(newIndex, totalSlides - 1));

            if (newIndex === currentSlideIndex) {
                return; // разрешаем вертикальный скролл
            }

            isScrolling = true;

            // Обновляем активный слайд и превью
            activatePreviewForSlide(newIndex);

            // Синхронизируем состояние с fullPage.js (для истории, URL и т.д.)
            fullpageInstance.moveTo(2, newIndex);

            setTimeout(() => {
                isScrolling = false;
            }, throttleDelay);

            event.preventDefault();
            event.stopPropagation();
        }

        function activatePreviewForSlide(slideIndex) {
            if (mediaQuery.matches) return;

            const slides = document.querySelectorAll('#section2 .slide');
            const previewItems = document.querySelectorAll('.preview-item');
            const carousel = document.querySelector('.preview-carousel');

            // Скрываем все слайды
            slides.forEach(slide => slide.classList.remove('active'));
            if (slides[slideIndex]) {
                slides[slideIndex].classList.add('active');
            }

            // Снимаем активность со всех превью
            previewItems.forEach(el => el.classList.remove('active'));
            if (previewItems[slideIndex]) {
                previewItems[slideIndex].classList.add('active');

                // ✅ Плавный скролл без дергания — вручную через scrollTop
                setTimeout(() => {
                    const element = previewItems[slideIndex];
                    const container = carousel;
                    if (element && container) {
                        const elementTop = element.offsetTop;
                        const elementHeight = element.offsetHeight;
                        const containerHeight = container.clientHeight;

                        // Центрируем элемент
                        container.scrollTop = elementTop - (containerHeight / 2) + (elementHeight / 2);
                    }
                }, 50);
            }
        }
        
        mediaQuery.addEventListener('change', function(e) {
            if (e.matches) {
                // Перешли в адаптив → отключаем всё
                removeWheelHandler();
            } else {
                // Вернулись в десктоп → восстанавливаем, если в секции 2
                const activeSection = fullpageInstance.getActiveSection();
                if (getSectionIndex(activeSection) === 1) {
                    attachWheelHandler();
                }
            }
        });

        document.querySelectorAll('.preview-item').forEach(item => {
            item.addEventListener('click', function () {
                if (mediaQuery.matches) return;

                const index = parseInt(this.getAttribute('data-index'));
                activatePreviewForSlide(index); // ← Сначала обновляем UI
                fullpageInstance.moveTo(2, index); // ← Затем синхронизируем состояние
            });
        });
        const initialSlides = document.querySelectorAll('#section2 .slide');
        if (initialSlides.length > 0) {
            initialSlides[0].classList.add('active');
        }
    });
</script>

</body>
</html>